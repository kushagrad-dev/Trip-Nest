<% layout('/layouts/boilerplate') %>
<script>
  console.log("INDEX PAGE LOADED");
</script>
<%= success %>
<style>
/* ---------- MODERN CARD DESIGN ---------- */
.listing-card{
  border-radius:18px;
  overflow:hidden;
  transition: all .35s ease;
  background:#fff;
}

.listing-card img{
  transition: transform .5s ease;
}

.listing-card:hover{
  transform: translateY(-8px);
  box-shadow:0 20px 40px rgba(0,0,0,0.15);
}

.listing-card:hover img{
  transform: scale(1.07);
}

.listing-card .card-body{
  padding:1rem 1.1rem;
}

/* ---------- FILTER BAR ---------- */
.filters-bar{
  background:#fff;
  padding:12px 18px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.modern-filter{
  padding:10px 14px;
  border-radius:12px;
  transition:.25s;
  font-weight:500;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
}

.modern-filter i{
  display:block;

  font-size:18px;
  margin-bottom:2px;
}

.modern-filter:hover{
  background:#fe424d;
  color:white !important;
  transform: translateY(-3px);
}

.modern-filter small{
  font-size:12px;
}
/* ---------- MOBILE OPTIMIZATION ---------- */
@media (max-width:575px){
  .filters-bar{
    overflow-x:auto;
    flex-wrap:nowrap;
    padding:10px;
  }

  .modern-filter{
    min-width:72px;
    font-size:12px;
  }

  .listing-card{
    border-radius:14px;
  }

  .listing-card .card-body{
    padding:.9rem;
  }

  .listing-card img{
    height:16rem !important;
  }
}
</style>
<!-- SEARCH / FILTER BAR -->
<form method="GET" action="/listings" class="row g-2 mb-4 align-items-center">

  <div class="col-md-3 mt-4">
    <input
      type="text"
      name="search"
      class="form-control"
      placeholder="Search location or title..."
      value="<%= filters?.search || '' %>"
    >
  </div>

  <div class="col-md-2 mt-4">
    <input
      type="number"
      name="minPrice"
      class="form-control"
      placeholder="Min Price"
      value="<%= filters?.minPrice || '' %>"
    >
  </div>

  <div class="col-md-2 mt-4">
    <input
      type="number"
      name="maxPrice"
      class="form-control"
      placeholder="Max Price"
      value="<%= filters?.maxPrice || '' %>"
    >
  </div>

  <div class="col-md-2 mt-4">
    <select name="sort" class="form-select">
      <option value="">Sort</option>
      <option value="low" <%= filters?.sort==='low'?'selected':'' %>>Price Low → High</option>
      <option value="high" <%= filters?.sort==='high'?'selected':'' %>>Price High → Low</option>
      <option value="new" <%= filters?.sort==='new'?'selected':'' %>>Newest</option>
    </select>
  </div>

  <div class="col-md-2 mt-4">
    <button type="submit" class="btn btn-danger w-100">Apply</button>
  </div>

  <div class="col-md-1 mt-4 ">
    <a href="/listings" class="btn btn-danger w-100">Reset</a>
  </div>

</form>

<div id="filters" class="filters-bar mb-4 d-flex flex-wrap gap-3 justify-content-center">

  <a href="/listings" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-earth-americas"></i>
    <small>All</small>
  </a>

  <a href="/listings?category=Trending" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-fire"></i>
    <small>Trending</small>
  </a>

  <a href="/listings?category=Rooms" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-bed"></i>
    <small>Rooms</small>
  </a>

  <a href="/listings?category=Cities" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-city"></i>
    <small>Iconic Cities</small>
  </a>

  <a href="/listings?category=Mountains" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-mountain"></i>
    <small>Mountains</small>
  </a>

  <a href="/listings?category=Castles" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-brands fa-fort-awesome"></i>
    <small>Castles</small>
  </a>

  <a href="/listings?category=Pools" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-person-swimming"></i>
    <small>Pools</small>
  </a>

  <a href="/listings?category=Camping" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-campground"></i>
    <small>Camping</small>
  </a>

  <a href="/listings?category=Farms" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-tractor"></i>
    <small>Farms</small>
  </a>

  <a href="/listings?category=Arctic" class="filter-tag modern-filter text-center text-decoration-none text-dark">
    <i class="fa-solid fa-snowflake"></i>
    <small>Arctic</small>
  </a>

  <div class="filter-tag modern-filter tax-toggle text-center">
    <label class="form-check-label d-block mb-1" for="checkNativeSwitch">
      <b>Price After Tax</b>
    </label>
    <div class="form-check form-switch d-flex justify-content-center">
      <input class="form-check-input" type="checkbox" id="checkNativeSwitch">
    </div>
  </div>

</div>

<div class="row row-cols-1 row-cols-sm-1 row-cols-md-2 row-cols-lg-3 g-3">
  <% for (let listing of allListings) { %>
    <div class="col">
      <a href="/listings/<%= listing._id %>" class="listing-link">
        <div class="card listing-card border-0 shadow-sm">
          <img 
            src="<%= listing.image.url %>"
            class="card-img-top" 
            alt="listing_image" 
            style="height:20rem; object-fit:cover;"
          >
          <div class="card-img-overlay"></div>
          <div class="card-body">
            <p class="card-text">
              <b><%= listing.title %></b> <br>
              &#8377; <%= listing.price.toLocaleString("en-IN") %> /night
            </p>
          </div>
        </div>
      </a>
    </div>
  <% } %>
</div>

<% if (totalPages > 1) { %>
<nav class="mt-4">
  <ul class="pagination justify-content-center">

    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
      <a class="page-link" href="?<%= new URLSearchParams({...filters, page: currentPage - 1}).toString() %>">Prev</a>
    </li>

    <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
        <a class="page-link" href="?<%= new URLSearchParams({...filters, page: i}).toString() %>"><%= i %></a>
      </li>
    <% } %>

    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
      <a class="page-link" href="?<%= new URLSearchParams({...filters, page: currentPage + 1}).toString() %>">Next</a>
    </li>

  </ul>
</nav>
</div>
  <% } %>
  <% if(allListings.length === 0){ %>
    <div class="text-center mt-5">
      <h4>No listings found</h4>
      <p>Try adjusting your search or filters.</p>
    </div>
  <% } %>

</div>

<script> 
  let taxSwitch = document.getElementById('checkNativeSwitch');
  if(!taxSwitch){
    console.error("Tax toggle switch not found");
  } else {
    console.log("Tax toggle initialized");
  }
  taxSwitch?.addEventListener('change', function() {
    console.log("Tax toggle changed:", taxSwitch.checked);
    let priceElements = document.querySelectorAll('.card-text');
    priceElements.forEach(el => {
      let priceText = el.innerHTML;
      let priceMatch = priceText.match(/₹\s?([\d,]+)/);
      if (priceMatch) {
        let price = parseInt(priceMatch[1].replace(/,/g, ''));
        if (taxSwitch.checked) {
          price = Math.round(price * 1.18); // Add 18% tax
        } else {
          price = Math.round(price / 1.18); // Remove tax
        }
        el.innerHTML = priceText.replace(/₹\s?[\d,]+/, `₹ ${price.toLocaleString("en-IN")}`);
      }
    });
  });
</script>

<!-- there are 2 topics visibility none and display hidden  -->